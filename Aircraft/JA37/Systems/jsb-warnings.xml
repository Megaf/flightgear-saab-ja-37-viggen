<?xml version="1.0"?>

<system name="warnings">
  <channel execrate="4" name="GVV">
    <!-- Stall warning (high alpha / high G-load / low speed)
         JA manual part 1 section 11.7
         AJS manual part 1 section 12.6 (AJS only has high alpha warning)
    -->

    <switch name="systems/sound/gvv/inhibit">
      <test logic="OR" value="1">
        gear/unit[0]/WOW eq 1
        /ja37/fuses/gvv eq 0
      </test>
      <default value="0"/>
    </switch>

    <!-- Inputs -->

    <pid name="systems/sound/gvv/alpha-dot-deg_sec">
      <input>instruments/aoa/alpha-deg</input>
      <kd>1</kd>
    </pid>

    <lag_filter name="systems/sound/gvv/alpha-dot-filter-deg_sec">
      <input>systems/sound/gvv/alpha-dot-deg_sec</input>
      <c1>4</c1>
    </lag_filter>

    <pid name="systems/sound/gvv/stick-dot-norm_sec">
      <input>fcs/elevator/input</input>
      <kd>-1</kd> <!-- positive = nose up -->
    </pid>

    <lag_filter name="systems/sound/gvv/stick-dot-filter-norm_sec">
      <input>systems/sound/gvv/stick-dot-norm_sec</input>
      <c1>4</c1>
    </lag_filter>

    <!-- Alpha warning -->

    <fcs_function name="systems/sound/gvv/alpha-warning-limit-JA-gear-up-deg">
      <function>
        <table>
          <independentVar lookup="row">instruments/altimeter/standard-altitude-m</independentVar>
          <tableData>
            10000  23.00
            13000  20.00
          </tableData>
        </table>
      </function>
    </fcs_function>

    <!-- AoA at which alpha warning triggers in stable flight -->
    <switch name="systems/sound/gvv/alpha-warning-limit">
      <!-- AJS: 15° in autopilot hold mode, or with gear down (except if α15.5° selected). Otherwise 18°. -->
      <test logic="AND" value="15">
        /ja37/systems/variant ne 0
        autoflight/mode ge 2
      </test>
      <test logic="AND" value="15">
        /ja37/systems/variant ne 0
        gear/gear-pos-norm gt 0
        autoflight/high-alpha eq 0
      </test>
      <test value="18">
        /ja37/systems/variant ne 0
      </test>
      <!-- JA: with gear up, depends on altitude. With gear down, 15°, or 18° if α15.5° selected. -->
      <test logic="AND" value="18">
        gear/gear-pos-norm gt 0
        autoflight/high-alpha eq 1
      </test>
      <test logic="AND" value="15">
        gear/gear-pos-norm gt 0
      </test>
      <default value="systems/sound/gvv/alpha-warning-limit-JA-gear-up-deg"/>
    </switch>

    <!-- Pre-warnings, 3° and 6° before warning (JA only, with gear up) -->
    <summer name="systems/sound/gvv/alpha-pre-warn-1-limit">
      <input>systems/sound/gvv/alpha-warning-limit</input>
      <bias>-6</bias>
    </summer>

    <summer name="systems/sound/gvv/alpha-pre-warn-2-limit">
      <input>systems/sound/gvv/alpha-warning-limit</input>
      <bias>-3</bias>
    </summer>

    <fcs_function name="systems/sound/gvv/alpha-predicted">
      <function>
        <sum>
          <property>instruments/aoa/alpha-deg</property>
          <product>
            <property>systems/sound/gvv/alpha-dot-filter-deg_sec</property>
            <value>0.5</value>
          </product>
          <product>
            <property>systems/sound/gvv/stick-dot-filter-norm_sec</property>
            <value>5</value>
          </product>
        </sum>
      </function>
    </fcs_function>

    <!-- 0: no warning, 1: pre-warning 1, 2: pre-warning 2, 3: warning -->
    <switch name="systems/sound/gvv/alpha-warning-level">
      <test value="0">
        systems/sound/gvv/inhibit eq 1
      </test>
      <test value="3">
        systems/sound/gvv/alpha-predicted ge systems/sound/gvv/alpha-warning-limit
      </test>
      <!-- pre-warning only with gear up -->
      <test logic="AND" value="2">
        systems/sound/gvv/alpha-predicted ge systems/sound/gvv/alpha-pre-warn-2-limit
        gear/gear-pos-norm eq 0
      </test>
      <test logic="AND" value="1">
        systems/sound/gvv/alpha-predicted ge systems/sound/gvv/alpha-pre-warn-1-limit
        gear/gear-pos-norm eq 0
      </test>
      <default value="0"/>
    </switch>

    <!-- G-load warning -->

    <!-- Factor applied to maximum allowed load (set through datapanel) -->
    <switch name="systems/sound/gvv/loadfactor-percent">
      <default value="/ja37/sound/loadfactor-percent"/>
      <test logic="OR" value="110">
        /instrumentation/terrain-override == 1
      </test>
    </switch>

    <fcs_function name="systems/sound/gvv/loadfactor-limit">
      <function>
        <product>
          <v>0.01</v>
          <p>systems/sound/gvv/loadfactor-percent</p>
          <p>/limits/max-positive-g</p>
        </product>
      </function>
    </fcs_function>

    <fcs_function name="systems/sound/gvv/loadfactor-predicted">
      <function>
        <sum>
          <property>instruments/accelerometer/indicated-g</property>
          <!-- Same predictive correction as for alpha.
             The manual specifies that loadfactor warning uses alpha-dot, and not nz-dot. -->
          <product>
            <property>systems/sound/gvv/alpha-dot-filter-deg_sec</property>
            <value>0.08</value>
          </product>
          <product>
            <property>systems/sound/gvv/stick-dot-filter-norm_sec</property>
            <value>0.8</value>
          </product>
        </sum>
      </function>
    </fcs_function>

    <fcs_function name="systems/sound/gvv/loadfactor-predicted-norm">
      <function>
        <quotient>
          <p>systems/sound/gvv/loadfactor-predicted</p>
          <p>systems/sound/gvv/loadfactor-limit</p>
        </quotient>
      </function>
    </fcs_function>

    <!-- 0: no warning, 1: pre-warning 1, 2: pre-warning 2, 3: warning -->
    <switch name="systems/sound/gvv/loadfactor-warning-level">
      <test value="0">
        systems/sound/gvv/inhibit eq 1
      </test>
      <test value="3">
        systems/sound/gvv/loadfactor-predicted-norm ge 1
      </test>
      <!-- pre-warning values are guesses -->
      <test logic="AND" value="2">
        systems/sound/gvv/loadfactor-predicted-norm ge 0.92
      </test>
      <test logic="AND" value="1">
        systems/sound/gvv/loadfactor-predicted-norm ge 0.85
      </test>
      <default value="0"/>
    </switch>

    <!-- Low speed warning
      Only partially implemented: warning when below flight idle at low speed.
      The warning should also come up when speed is so low that MIL power will give insufficient acceleration.
    -->

    <switch name="systems/sound/gvv/speed-warning">
      <test value="0">
        systems/sound/gvv/inhibit eq 1
      </test>
      <test logic="AND" value="1">
        instruments/airspeed/airspeed-kmh lt 375
        instruments/altimeter/altitude-aal-m lt 1200
        <test logic="OR"><!-- above 30m at landing (radar alt, or altimeter if unavailable) -->
          /ja37/hud/landing-mode eq 0
          <test logic="AND">
            instruments/radar-altimeter/ready eq 1
            instruments/radar-altimeter/radar-altitude-m gt 30
          </test>
          <test logic="AND">
            instruments/radar-altimeter/ready eq 0
            instruments/altimeter/altitude-aal-m gt 30
          </test>
        </test>
        fcs/throttle-pos-deg lt 19        <!-- below flight idle -->
        autoflight/athr eq 0            <!-- inhibited by A/T -->
      </test>
      <default value="0"/>
    </switch>
  </channel>


  <channel execrate="4" name="MKV">
    <!-- Ground proximity / collision warning.
      JA37D SFI part 1 sec 16.5 / AJS37 SFI part 1 sec 23
    -->

    <!-- Terrain proximity warning
      Indicates that radar altitude is significantly lower than indicated altitude.
    -->

    <pure_gain name="systems/mkv/terrain-warning-limit">
      <!-- terrain warning triggers at radar-alt < baro-alt/2 -->
      <input>instruments/altimeter/altitude-aal-m</input>
      <gain>0.5</gain>
    </pure_gain>

    <switch name="systems/mkv/terrain-warning-enable-ja">
      <!-- inhibit by takeoff mode, and control switch -->
      <test logic="OR" value="0">
        /ja37/avionics/collision-warning eq 0
        /ja37/mode/takeoff eq 1
      </test>
      <!-- gear down, LB, LF, or L+within 40km of airbase -->
      <test logic="OR" value="1">
        gear/gear-pos-norm eq 1
        ja37/hud/landing-mode eq 1
      </test>
      <default value="0"/>
    </switch>

    <switch name="systems/mkv/terrain-warning">
      <!-- JA: enable conditions above -->
      <test logic="AND" value="0">
        /ja37/systems/variant eq 0
        systems/mkv/terrain-warning-enable-ja eq 0
      </test>
      <!-- AJS: requires LD mode -->
      <test logic="AND" value="0">
        /ja37/systems/variant ne 0
        /ja37/hud/switch-hojd eq 1
      </test>
      <!-- inhibit at low altitude with gear down (landing) -->
      <test logic="AND" value="0">
        gear/gear-pos-norm eq 1
        instruments/radar-altimeter/radar-altitude-m lt 50
      </test>
      <test logic="AND" value="1">
        instruments/radar-altimeter/ready eq 1
        instruments/radar-altimeter/radar-altitude-m lt 150
        instruments/radar-altimeter/radar-altitude-m lt systems/mkv/terrain-warning-limit
      </test>
      <default value="0"/>
    </switch>
  </channel>
</system>
